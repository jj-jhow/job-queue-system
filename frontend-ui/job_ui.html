<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Submitter & Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
        integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
        crossorigin="anonymous"></script>
    <style>
        /* Custom Styles (same as before) */
        body {
            font-family: 'Inter', sans-serif;
        }

        .log-entry {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 2px 5px;
            margin-bottom: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .log-entry:nth-child(even) {
            background-color: #f8f9fa;
        }

        .log-entry.error {
            color: #dc3545;
            font-weight: bold;
        }

        .log-entry.success {
            color: #198754;
            font-weight: bold;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            overflow: hidden;
            height: 1rem;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background-color: #0d6efd;
            color: white;
            text-align: center;
            line-height: 1rem;
            font-size: 0.75rem;
            transition: width 0.3s ease-in-out;
            border-radius: 0.25rem;
        }

        .job-status-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .job-status-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .job-status-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .status-queued {
            background-color: #6c757d;
            color: white;
        }

        .status-waiting {
            background-color: #6c757d;
            color: white;
        }

        /* Added for BullMQ state */
        .status-active {
            background-color: #0d6efd;
            color: white;
        }

        /* Added for BullMQ state */
        .status-processing {
            background-color: #0d6efd;
            color: white;
        }

        /* Keep for compatibility if needed */
        .status-completed {
            background-color: #198754;
            color: white;
        }

        .status-failed {
            background-color: #dc3545;
            color: white;
        }

        .status-delayed {
            background-color: #ffc107;
            color: black;
        }

        /* Added for BullMQ state */
        .status-paused {
            background-color: #adb5bd;
            color: black;
        }

        /* Added for BullMQ state */
        .status-unknown {
            background-color: #adb5bd;
            color: black;
        }

        /* Added for BullMQ state */
        .status-not_found {
            background-color: #ffc107;
            color: black;
        }

        html,
        body {
            height: 100%;
            margin: 0;
        }

        .main-container {
            min-height: calc(100vh - 4rem);
        }

        .flex-grow-1 {
            flex-grow: 1;
        }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8 h-full">

    <div class="container mx-auto bg-white rounded-lg shadow-lg p-6 h-full flex flex-col">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-700">Job Submitter & Monitor</h1>

        <div id="ws-status" class="mb-4 text-center p-2 rounded-md">Initializing...</div>

        <div class="flex flex-col md:flex-row gap-6 flex-grow-1">

            <div class="w-full md:w-1/3 flex flex-col">
                <h2 class="text-xl font-semibold mb-3 text-gray-600">Submit New Job</h2>
                <div class="flex flex-col flex-grow-1">
                    <label for="jobName" class="block text-sm font-medium text-gray-700 mb-1">Job Name</label>
                    <input type="text" id="jobName" value="defaultJobName"
                        class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">

                    <label for="jobPayload" class="block text-sm font-medium text-gray-700 mb-1">Job Payload
                        (JSON)</label>
                    <textarea id="jobPayload" rows="10"
                        class="w-full p-2 border border-gray-300 rounded-md flex-grow-1 focus:ring-blue-500 focus:border-blue-500"
                        placeholder='{ "url": "http://example.com/file.zip", "priority": 1 }'></textarea>

                    <button id="submitJobBtn"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50">
                        Submit Job
                    </button>
                    <div id="submitError" class="text-red-600 mt-2 text-sm"></div>
                    <div id="submitSuccess" class="text-green-600 mt-2 text-sm"></div>
                </div>
            </div>

            <div class="w-full md:w-2/3">
                <h2 class="text-xl font-semibold mb-3 text-gray-600">Job Status</h2>
                <div id="jobStatusContainer"
                    class="h-96 md:h-full overflow-y-auto bg-gray-50 p-4 border border-gray-200 rounded-md">
                    <p class="text-gray-500">Job statuses will appear here...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const jobPayloadInput = document.getElementById('jobPayload');
        const jobNameInput = document.getElementById('jobName');
        const submitJobBtn = document.getElementById('submitJobBtn');
        const jobStatusContainer = document.getElementById('jobStatusContainer');
        const submitError = document.getElementById('submitError');
        const submitSuccess = document.getElementById('submitSuccess');
        const wsStatusDiv = document.getElementById('ws-status');

        const backendUrl = 'http://localhost:3000';
        const socketIoUrl = 'ws://localhost:3000';

        let socket; // Socket.IO instance

        // --- Socket.IO Handling ---

        function connectSocketIO() {
            wsStatusDiv.textContent = 'Connecting...';
            wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-yellow-100 text-yellow-800';

            socket = io(backendUrl, {
                // transports: ['websocket', 'polling'] // Optional
            });

            socket.on('connect', () => {
                console.log('Socket.IO connected:', socket.id);
                wsStatusDiv.textContent = 'Connected';
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-green-100 text-green-800';
            });

            socket.on('jobStatusUpdate', (jobUpdate) => {
                console.log('Socket.IO message received (jobStatusUpdate):', jobUpdate);
                if (jobUpdate && jobUpdate.id) {
                    updateJobStatusDisplay(jobUpdate);
                } else {
                    console.warn("Received non-standard jobStatusUpdate message:", jobUpdate);
                }
            });

            socket.on('jobQueued', (jobQueuedData) => {
                console.log('Socket.IO message received (jobQueued):', jobQueuedData);
                if (jobQueuedData && jobQueuedData.id) {
                    updateJobStatusDisplay(jobQueuedData);
                }
            });

            socket.on('connect_error', (err) => {
                console.error('Socket.IO connection error:', err);
                wsStatusDiv.textContent = `Connection Error: ${err.message}`;
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-red-100 text-red-800';
            });

            socket.on('disconnect', (reason) => {
                console.log('Socket.IO disconnected:', reason);
                wsStatusDiv.textContent = `Disconnected: ${reason}`;
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-red-100 text-red-800';
            });
        }

        // --- Job Status Display ---

        function updateJobStatusDisplay(jobData) {
            const placeholder = jobStatusContainer.querySelector('p.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }

            let jobCard = document.getElementById(`job-${jobData.id}`);
            if (!jobCard) {
                jobCard = document.createElement('div');
                jobCard.id = `job-${jobData.id}`;
                jobCard.className = 'job-status-card';
                jobStatusContainer.insertBefore(jobCard, jobStatusContainer.firstChild);
            }

            let statusClass = `status-${jobData.status || 'unknown'}`;
            if (jobData.status === 'processing') statusClass = 'status-active'; // Map legacy status

            // *** FIX: Use standard JS checks instead of 'as any' ***
            const progressValue = (typeof jobData.progress === 'object' && jobData.progress !== null && jobData.progress.hasOwnProperty('percentage'))
                ? jobData.progress.percentage
                : (typeof jobData.progress === 'number' ? jobData.progress : 0);

            jobCard.innerHTML = `
                <h3>
                    Job: ${jobData.name || 'N/A'} (${jobData.id})
                    <span class="job-status-badge ${statusClass}">${jobData.status || 'unknown'}</span>
                </h3>
                ${jobData.status === 'active' || jobData.status === 'completed' ? `
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressValue}%">
                            ${progressValue}%
                        </div>
                    </div>
                ` : ''}
                ${jobData.error ? `<p class="text-red-600 text-sm mb-2"><strong>Error:</strong> ${jobData.error}</p>` : ''}
                ${jobData.result ? `<p class="text-green-700 text-sm mb-2"><strong>Result:</strong> ${JSON.stringify(jobData.result)}</p>` : ''}
                <div class="text-sm font-semibold mb-1">Logs:</div>
                <div class="logs-container max-h-40 overflow-y-auto border border-gray-200 p-2 rounded bg-white">
                    ${(jobData.logs || []).map(log => `<div class="log-entry ${log.includes('failed') || log.includes('Error') ? 'error' : (log.includes('completed successfully') ? 'success' : '')}">${log}</div>`).join('')}
                </div>
            `;

            const logsContainer = jobCard.querySelector('.logs-container');
            if (logsContainer) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }


        // --- Job Submission ---

        submitJobBtn.addEventListener('click', async () => {
            const payloadString = jobPayloadInput.value.trim();
            const jobName = jobNameInput.value.trim();
            submitError.textContent = '';
            submitSuccess.textContent = '';

            if (!payloadString) {
                submitError.textContent = 'Job payload cannot be empty.';
                return;
            }
            if (!jobName) {
                submitError.textContent = 'Job name cannot be empty.';
                return;
            }

            let payload;
            try {
                payload = JSON.parse(payloadString);
            } catch (error) {
                submitError.textContent = 'Invalid JSON payload: ' + error.message;
                return;
            }

            submitJobBtn.disabled = true;
            submitJobBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${backendUrl}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: jobName, payload: payload }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `HTTP error! status: ${response.status}`);
                }

                submitSuccess.textContent = `Job submitted successfully! Job ID: ${result.jobId}`;
                jobPayloadInput.value = '';
                // 'jobQueued' event handles UI update

            } catch (error) {
                console.error('Error submitting job:', error);
                submitError.textContent = 'Failed to submit job: ' + error.message;
            } finally {
                submitJobBtn.disabled = false;
                submitJobBtn.textContent = 'Submit Job';
            }
        });

        // --- Initial Load ---
        connectSocketIO(); // Start Socket.IO connection

    </script>

</body>

</html>