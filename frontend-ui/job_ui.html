<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Submitter & Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
    <style>
        /* Custom Styles (same as before) */
        body {
            font-family: 'Inter', sans-serif;
        }
        .log-entry {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 2px 5px;
            margin-bottom: 2px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .log-entry:nth-child(even) {
            background-color: #f8f9fa;
        }
        .log-entry.error { color: #dc3545; font-weight: bold; }
        .log-entry.success { color: #198754; font-weight: bold; }
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; height: 1rem; margin-top: 5px; margin-bottom: 10px; }
        .progress-bar { height: 100%; background-color: #0d6efd; color: white; text-align: center; line-height: 1rem; font-size: 0.75rem; transition: width 0.3s ease-in-out; border-radius: 0.25rem; }
        .job-status-card { border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; background-color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        .job-status-card h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; word-break: break-all; }
        .job-status-badge { display: inline-block; padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.25rem; margin-left: 0.5rem; }
        .status-queued { background-color: #6c757d; color: white; }
        .status-processing { background-color: #0d6efd; color: white; }
        .status-completed { background-color: #198754; color: white; }
        .status-failed { background-color: #dc3545; color: white; }
        .status-not_found { background-color: #ffc107; color: black; }
        html, body { height: 100%; margin: 0; }
        .main-container { min-height: calc(100vh - 4rem); }
        .flex-grow-1 { flex-grow: 1; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 h-full">

    <div class="container mx-auto bg-white rounded-lg shadow-lg p-6 h-full flex flex-col">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-700">Job Submitter & Monitor</h1>

        <div id="ws-status" class="mb-4 text-center p-2 rounded-md">Initializing...</div>

        <div class="flex flex-col md:flex-row gap-6 flex-grow-1">

            <div class="w-full md:w-1/3 flex flex-col">
                <h2 class="text-xl font-semibold mb-3 text-gray-600">Submit New Job</h2>
                <div class="flex flex-col flex-grow-1">
                     <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Job Type</label>
                     <input type="text" id="jobType" value="defaultJobType" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">

                    <label for="jobPayload" class="block text-sm font-medium text-gray-700 mb-1">Job Payload (JSON)</label>
                    <textarea id="jobPayload" rows="10" class="w-full p-2 border border-gray-300 rounded-md flex-grow-1 focus:ring-blue-500 focus:border-blue-500" placeholder='{ "url": "http://example.com/file.zip", "priority": 1 }'></textarea>

                    <button id="submitJobBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50">
                        Submit Job
                    </button>
                    <div id="submitError" class="text-red-600 mt-2 text-sm"></div>
                    <div id="submitSuccess" class="text-green-600 mt-2 text-sm"></div>
                </div>
            </div>

            <div class="w-full md:w-2/3">
                <h2 class="text-xl font-semibold mb-3 text-gray-600">Job Status</h2>
                <div id="jobStatusContainer" class="h-96 md:h-full overflow-y-auto bg-gray-50 p-4 border border-gray-200 rounded-md">
                    <p class="text-gray-500">Job statuses will appear here...</p>
                    </div>
            </div>

        </div>
    </div>

    <script>
        const jobPayloadInput = document.getElementById('jobPayload');
        const jobTypeInput = document.getElementById('jobType');
        const submitJobBtn = document.getElementById('submitJobBtn');
        const jobStatusContainer = document.getElementById('jobStatusContainer');
        const submitError = document.getElementById('submitError');
        const submitSuccess = document.getElementById('submitSuccess');
        const wsStatusDiv = document.getElementById('ws-status');

        const backendUrl = 'http://localhost:3000'; // Your backend API URL
        const socketIoUrl = 'ws://localhost:3000'; // URL for Socket.IO connection

        let socket; // Socket.IO instance

        // --- Socket.IO Handling ---

        function connectSocketIO() {
            wsStatusDiv.textContent = 'Connecting...';
            wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-yellow-100 text-yellow-800';

            // Initialize Socket.IO client connection
            // No need to specify 'ws://' explicitly for socket.io client,
            // it defaults based on the page's protocol or handles it.
            // Use the backend base URL.
            socket = io(backendUrl, {
                // Optional: Add transports if needed, but defaults are usually fine
                // transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('Socket.IO connected:', socket.id);
                wsStatusDiv.textContent = 'Connected';
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-green-100 text-green-800';
            });

            // Listen for the specific event emitted by the server
            socket.on('jobStatusUpdate', (jobUpdate) => {
                console.log('Socket.IO message received (jobStatusUpdate):', jobUpdate);
                 if (jobUpdate && jobUpdate.id) { // Basic check for valid update structure
                     updateJobStatusDisplay(jobUpdate);
                 } else {
                     console.warn("Received non-standard jobStatusUpdate message:", jobUpdate);
                 }
            });

             // Listen for other potential events (optional)
             socket.on('jobQueued', (jobQueuedData) => {
                 console.log('Socket.IO message received (jobQueued):', jobQueuedData);
                 // You might want to add the job to the display immediately here too
                 updateJobStatusDisplay(jobQueuedData); // Assuming structure is compatible
             });

            socket.on('connect_error', (err) => {
                console.error('Socket.IO connection error:', err);
                wsStatusDiv.textContent = `Connection Error: ${err.message}`;
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-red-100 text-red-800';
                // Socket.IO client handles reconnection attempts automatically by default
            });

            socket.on('disconnect', (reason) => {
                console.log('Socket.IO disconnected:', reason);
                wsStatusDiv.textContent = `Disconnected: ${reason}`;
                wsStatusDiv.className = 'mb-4 text-center p-2 rounded-md bg-red-100 text-red-800';
                // If the server disconnects, it will attempt to reconnect automatically.
                // If the reason is 'io client disconnect', it means socket.disconnect() was called manually.
            });
        }

        // --- Job Status Display (Function remains the same) ---

        function updateJobStatusDisplay(jobData) {
            const placeholder = jobStatusContainer.querySelector('p.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }

            let jobCard = document.getElementById(`job-${jobData.id}`);
            if (!jobCard) {
                jobCard = document.createElement('div');
                jobCard.id = `job-${jobData.id}`;
                jobCard.className = 'job-status-card';
                jobStatusContainer.insertBefore(jobCard, jobStatusContainer.firstChild);
            }

            let statusClass = 'status-queued';
            switch (jobData.status) {
                case 'processing': statusClass = 'status-processing'; break;
                case 'completed': statusClass = 'status-completed'; break;
                case 'failed': statusClass = 'status-failed'; break;
                case 'not_found': statusClass = 'status-not_found'; break;
            }

            jobCard.innerHTML = `
                <h3>
                    Job ID: ${jobData.id}
                    <span class="job-status-badge ${statusClass}">${jobData.status}</span>
                </h3>
                ${jobData.status === 'processing' || jobData.status === 'completed' ? `
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${jobData.progress || 0}%">${jobData.progress || 0}%</div>
                    </div>
                ` : ''}
                ${jobData.error ? `<p class="text-red-600 text-sm mb-2"><strong>Error:</strong> ${jobData.error}</p>` : ''}
                ${jobData.result ? `<p class="text-green-700 text-sm mb-2"><strong>Result:</strong> ${JSON.stringify(jobData.result)}</p>` : ''}
                <div class="text-sm font-semibold mb-1">Logs:</div>
                <div class="logs-container max-h-40 overflow-y-auto border border-gray-200 p-2 rounded bg-white">
                    ${(jobData.logs || []).map(log => `<div class="log-entry ${log.includes('failed') || log.includes('Error') ? 'error' : (log.includes('completed successfully') ? 'success' : '')}">${log}</div>`).join('')}
                </div>
            `;

            const logsContainer = jobCard.querySelector('.logs-container');
            if (logsContainer) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }


        // --- Job Submission (Function remains the same) ---

        submitJobBtn.addEventListener('click', async () => {
            const payloadString = jobPayloadInput.value.trim();
            const jobType = jobTypeInput.value.trim();
            submitError.textContent = '';
            submitSuccess.textContent = '';

            if (!payloadString) {
                submitError.textContent = 'Job payload cannot be empty.';
                return;
            }
             if (!jobType) {
                submitError.textContent = 'Job type cannot be empty.';
                return;
            }

            let payload;
            try {
                payload = JSON.parse(payloadString);
            } catch (error) {
                submitError.textContent = 'Invalid JSON payload: ' + error.message;
                return;
            }

            submitJobBtn.disabled = true;
            submitJobBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${backendUrl}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type: jobType, payload: payload }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `HTTP error! status: ${response.status}`);
                }

                submitSuccess.textContent = `Job submitted successfully! Job ID: ${result.jobId}`;
                jobPayloadInput.value = '';
                // No need to manually add the card here if the backend emits 'jobQueued'
                // Otherwise, keep this:
                // updateJobStatusDisplay({
                //     id: result.jobId,
                //     status: 'queued',
                //     progress: 0,
                //     logs: [`[${new Date().toISOString()}] Job ${result.jobId} submitted via UI.`]
                // });

            } catch (error) {
                console.error('Error submitting job:', error);
                submitError.textContent = 'Failed to submit job: ' + error.message;
            } finally {
                submitJobBtn.disabled = false;
                submitJobBtn.textContent = 'Submit Job';
            }
        });

        // --- Initial Load ---
        connectSocketIO(); // Use the new Socket.IO connection function

    </script>

</body>
</html>
